<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="css/client.css" type="text/css" />
    </head>
    <body>
        <form onsubmit="onSubmitForm(event)">
            <div class="client-container">
                <select class="channel-list" name="channel-list" size="10" onselect="changeChannel(event)">
                    <optgroup class="channel-list-group" label="Channel List">
                    </optgroup>
                </select>
                <div class="channel-container">
                    <div class="channel-output"></div>
                    <input class="channel-submit" type="submit" value="Send" />
                    <input placeholder="Send a message to the channel" class="channel-message" onkeydown="onSubmitForm(event)" />
                </div>
            </div>
        </form>

        <script type="text/javascript">
            var socketWorker = new Worker('js/socket-worker.js');
            var channelLog = {};
            var currentChannel = '/empty';
            socketWorker.addEventListener('message', function(e) {
                var args = e.data.split(/\s+/);
                switch(args[0].toLowerCase()) {
                    case 'message':
                        args.shift();
                        var user = args.shift();
                        var path = args.shift();
                        var content = args.join(' ');
                        var formatted = '<span class="user">' + user + '</span>: <span class="message">' + content + '</span>';
                        if(typeof channelLog[path] === 'undefined')
                            channelLog[path] = formatted;
                        else
                            channelLog[path] += formatted;

                        var channelOption = document.getElementById('channel:' + path);
                        if(!channelOption) {
                            channelOption = document.createElement('option');
                            channelOption.innerHTML = path;
                            channelOption.setAttribute('id', 'channel:' + path);
                            var listGroup = document.getElementsByClassName('channel-list-group');
                            for(var lgi=0; lgi<listGroup.length; lgi++)
                                listGroup[lgi].appendChild(channelOption);
                        }

                        var divMessages = document.getElementsByClassName("channel-output");
                        for(var i=0; i<divMessages.length; i++) {
                            var divLog = document.createElement('div');
                            divLog.setAttribute('class', 'channel-log');
                            divLog.innerHTML = formatted;
                            divMessages[i].appendChild(divLog);
                        }
                        break;
                    case 'error':
                        console.error(e.data);
                        break;
                    default:
                        console.info(e.data);
                        break;
                }
            }, true);

            function sendCommand() {
                var inputMessage = document.getElementsByClassName('channel-message');
                for(var i=0; i<inputMessage.length; i++) {
                    var message = inputMessage[i].value;
                    if(!message)
                        continue;
                    if(message[0] === '/')
                        message = message.substr(1);
                    else
                        message = "MESSAGE " + currentChannel + " " + message;
                    socketWorker.postMessage(message);
                    inputMessage[i].value = '';
                    inputMessage[i].focus();
                }
            }

            function onSubmitForm(e) {
                switch(e.type) {
                    case 'keydown':
                        if(e.keyCode === 13) {
                            e.preventDefault();
                            sendCommand();
                        }
                        break;

                    case 'submit':
                        e.preventDefault();
                        sendCommand();
                        break;

                    default:
                        throw new Error("Unknown event: " + e.type);
                }
                return false;
            }

            function changeChannel(e) {

            }

        </script>
       
    </body>
</html>
